<form id="edit_patient_form" class="container my-4 d-none">
  <header class="row">
    <h2 class="col px-0">Edit patient</h2>
    <div class="spinner spinner-border ms-auto d-none" role="status" aria-hidden="true"></div>
  </header>

  <fieldset class="row mb-2">
    <input class="col me-2" type="text" name="name" placeholder="Name" required>
    <input class="col me-2" type="text" name="middleName" placeholder="Middle name">
    <input class="col" type="text" name="familyName" placeholder="Family name" required>
  </fieldset>

  <fieldset class="row mb-2">
    <input class="col me-2" type="tel" name="phone" placeholder="Telephone">
    <input class="col" type="text" name="egn" placeholder="EGN" required maxlength="10" minlength="10">
  </fieldset>

  <fieldset class="row mb-2">
    <input class="col me-2" type="text" name="city" placeholder="City">
    <input class="col" type="text" name="street" placeholder="Street">
  </fieldset>

  <fieldset class="row mb-2">
    <input class="col me-2" type="text" name="occupation" placeholder="Occupation">
    <input class="col" type="email" name="email" placeholder="Email">
  </fieldset>

  <div class="row mb-2">
    <fieldset class="col border-start me-2">
      <p class="mb-0">Allergies</p>
      <label for="allergies1">Yes</label>
      <input type="radio" id="allergies1" name="hasAllergies" value="1" required>
      <label class="ms-2" for="allergies2">No</label>
      <input type="radio" id="allergies2" name="hasAllergies" value="0" required>
    </fieldset>

    <fieldset class="col border-start">
      <p class="mb-0">Smoker</p>
      <label for="smoker1">Yes</label>
      <input type="radio" id="smoker1" name="isSmoker" value="1">
      <label class="ms-2" for="smoker2">No</label>
      <input type="radio" id="smoker2" name="isSmoker" value="0">
    </fieldset>
  </div>

  <div class='row justify-content-end'>
    <input class="col-2" type="submit" value="Save">
  </div>

  <div class="spinner row align-items-center d-none">
    <strong>Loading...</strong>
    <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
  </div>

  <div class='row mt-4'>
    <div class="alert alert-success d-none" role="alert">Patient data saved</div>
    <div class="alert alert-danger d-none" role="alert" data-default-text="Something went wrong">Something went wrong</div>
  </div>
</form>

<script>
  ((w, d, g) => {
    const FORM_ID = '#edit_patient_form'

    w.addEventListener('storage', loadPatientData)

    function loadPatientData() {
      toggleHeaderSpinner()
      const patientId = w.sessionStorage.getItem('patientId')
      g.script.run.withSuccessHandler(handlePatientData).getPatientById(patientId)
    }

    function handlePatientData(data) {
      d.querySelector(`${FORM_ID}`).reset()
      populateForm(data)
      clearAlerts()
      toggleHeaderSpinner()
    }

    function populateForm(patientData) {
      const { elements } = d.querySelector(`${FORM_ID}`)

      for (const [key, value] of Object.entries(patientData)) {
        const field = elements.namedItem(key)
        field && (field.value = value)
      }
    }

    d.querySelector(`${FORM_ID}`).addEventListener('submit', editExistingPatient)

    function editExistingPatient() {
      event.preventDefault()
      clearAlerts()
      toggleFormSpinner()

      const formData = new FormData(event.target)
      const patientId = w.sessionStorage.getItem('patientId')
      g.script.run.withSuccessHandler(handleSubmissionResponse)
        .editPatient(patientId, Object.fromEntries(formData))
    }

    function handleSubmissionResponse(response) {
      toggleFormSpinner()

      if (response.error) {
        const alert = d.querySelector(`${FORM_ID} .alert-danger`)
        alert.innerText = alert.dataset.defaultText
        alert.innerText = response.error?.message ?
          response.error?.message : alert.innerText
        alert.classList.remove('d-none')
      }
      else {
        d.querySelector(`${FORM_ID} .alert-success`).classList.remove('d-none')
        storePatientId(response.patientId)
      }
    }

    function storePatientId(id) {
      w.sessionStorage.setItem('patientId', id)
      w.dispatchEvent(new Event('storage'))
    }

    function clearAlerts() {
      d.querySelectorAll(`${FORM_ID} .alert`).forEach(a => a.classList.add('d-none'))
    }

    function toggleHeaderSpinner() {
      d.querySelector(`${FORM_ID} header .spinner`).classList.toggle('d-none')
    }

    function toggleFormSpinner() {
      d.querySelector(`${FORM_ID} > .spinner`).classList.toggle('d-none')
    }
  })(window, document, google)
</script>
