<form id="teeth_map_form" class="container my-4">
  <header class="row">
    <h2 class="col px-0">Teeth map</h2>
    <div class="spinner spinner-border ms-auto d-none" role="status" aria-hidden="true"></div>
  </header>

  <div class="row">
    <div class="col-8 d-flex flex-column justify-content-center">
      <div class="row">
        <div class="col-6 pe-0 border-end border-dark">
          <div class="d-flex flex-row-reverse">
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i51">51</div><input type="checkbox" name="51" value="51"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i52">52</div><input type="checkbox" name="52" value="52"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i53">53</div><input type="checkbox" name="53" value="53"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i54">54</div><input type="checkbox" name="54" value="54"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i55">55</div><input type="checkbox" name="55" value="55"></div>
          </div>
          <div class="d-flex flex-row-reverse">
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i11">11</div><input type="checkbox" name="11" value="11"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i12">12</div><input type="checkbox" name="12" value="12"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i13">13</div><input type="checkbox" name="13" value="13"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i14">14</div><input type="checkbox" name="14" value="14"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i15">15</div><input type="checkbox" name="15" value="15"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i16">16</div><input type="checkbox" name="16" value="16"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i17">17</div><input type="checkbox" name="17" value="17"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-position" id="i18">18</div><input type="checkbox" name="18" value="18"></div>
          </div>
          <div class="d-flex flex-row-reverse border-bottom border-dark">
            <div class="cell border-start border-top border-dark"><input type="text" autocomplete="off" name="q1-1"></div>
            <div class="cell border-start border-top border-dark"><input type="text" autocomplete="off" name="q1-2"></div>
            <div class="cell border-start border-top border-dark"><input type="text" autocomplete="off" name="q1-3"></div>
            <div class="cell border-start border-top border-dark"><input type="text" autocomplete="off" name="q1-4"></div>
            <div class="cell border-start border-top border-dark"><input type="text" autocomplete="off" name="q1-5"></div>
            <div class="cell border-start border-top border-dark"><input type="text" autocomplete="off" name="q1-6"></div>
            <div class="cell border-start border-top border-dark"><input type="text" autocomplete="off" name="q1-7"></div>
            <div class="cell border-start border-top border-dark"><input type="text" autocomplete="off" name="q1-8"></div>
          </div>
        </div>

        <div class="col-6 ps-0 border-start border-dark">
          <div class="d-flex flex-row">
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i61">61</div><input type="checkbox" name="61" value="61"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i62">62</div><input type="checkbox" name="62" value="62"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i63">63</div><input type="checkbox" name="63" value="63"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i64">64</div><input type="checkbox" name="64" value="64"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i65">65</div><input type="checkbox" name="65" value="65"></div>
          </div>
          <div class="d-flex flex-row">
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i21">21</div><input type="checkbox" name="21" value="21"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i22">22</div><input type="checkbox" name="22" value="22"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i23">23</div><input type="checkbox" name="23" value="23"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i24">24</div><input type="checkbox" name="24" value="24"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i25">25</div><input type="checkbox" name="25" value="25"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i26">26</div><input type="checkbox" name="26" value="26"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i27">27</div><input type="checkbox" name="27" value="27"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-position" id="i28">28</div><input type="checkbox" name="28" value="28"></div>
          </div>
          <div class="d-flex flex-row border-bottom border-dark">
            <div class="cell border-end border-top border-dark"><input type="text" autocomplete="off" name="q2-1"></div>
            <div class="cell border-end border-top border-dark"><input type="text" autocomplete="off" name="q2-2"></div>
            <div class="cell border-end border-top border-dark"><input type="text" autocomplete="off" name="q2-3"></div>
            <div class="cell border-end border-top border-dark"><input type="text" autocomplete="off" name="q2-4"></div>
            <div class="cell border-end border-top border-dark"><input type="text" autocomplete="off" name="q2-5"></div>
            <div class="cell border-end border-top border-dark"><input type="text" autocomplete="off" name="q2-6"></div>
            <div class="cell border-end border-top border-dark"><input type="text" autocomplete="off" name="q2-7"></div>
            <div class="cell border-end border-top border-dark"><input type="text" autocomplete="off" name="q2-8"></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-6 pe-0 border-end border-dark">
          <div class="d-flex flex-row-reverse border-top border-dark">
            <div class="cell border-start border-bottom border-dark"><input type="text" autocomplete="off" name="q4-1"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" autocomplete="off" name="q4-2"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" autocomplete="off" name="q4-3"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" autocomplete="off" name="q4-4"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" autocomplete="off" name="q4-5"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" autocomplete="off" name="q4-6"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" autocomplete="off" name="q4-7"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" autocomplete="off" name="q4-8"></div>
          </div>
          <div class="d-flex flex-row-reverse">
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i41">41</div><input type="checkbox" name="41" value="41"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i42">42</div><input type="checkbox" name="42" value="42"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i43">43</div><input type="checkbox" name="43" value="43"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i44">44</div><input type="checkbox" name="44" value="44"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i45">45</div><input type="checkbox" name="45" value="45"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i46">46</div><input type="checkbox" name="46" value="46"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i47">47</div><input type="checkbox" name="47" value="47"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i48">48</div><input type="checkbox" name="48" value="48"></div>
          </div>
          <div class="d-flex flex-row-reverse">
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i81">81</div><input type="checkbox" name="81" value="81"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i82">82</div><input type="checkbox" name="82" value="82"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i83">83</div><input type="checkbox" name="83" value="83"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i84">84</div><input type="checkbox" name="84" value="84"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-position" id="i85">85</div><input type="checkbox" name="85" value="85"></div>
          </div>
        </div>

        <div class="col-6 ps-0 border-start border-dark">
          <div class="d-flex flex-row border-top border-dark">
            <div class="cell border-end border-bottom border-dark"><input type="text" autocomplete="off" name="q3-1"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" autocomplete="off" name="q3-2"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" autocomplete="off" name="q3-3"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" autocomplete="off" name="q3-4"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" autocomplete="off" name="q3-5"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" autocomplete="off" name="q3-6"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" autocomplete="off" name="q3-7"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" autocomplete="off" name="q3-8"></div>
          </div>
          <div class="d-flex flex-row">
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i31">31</div><input type="checkbox" name="31" value="31"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i32">32</div><input type="checkbox" name="32" value="32"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i33">33</div><input type="checkbox" name="33" value="33"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i34">34</div><input type="checkbox" name="34" value="34"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i35">35</div><input type="checkbox" name="35" value="35"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i36">36</div><input type="checkbox" name="36" value="36"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i37">37</div><input type="checkbox" name="37" value="37"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i38">38</div><input type="checkbox" name="38" value="38"></div>
          </div>
          <div class="d-flex flex-row">
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i71">71</div><input type="checkbox" name="71" value="71"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i72">72</div><input type="checkbox" name="72" value="72"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i73">73</div><input type="checkbox" name="73" value="73"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i74">74</div><input type="checkbox" name="74" value="74"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-position" id="i75">75</div><input type="checkbox" name="75" value="75"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-4">
      <table class="table">
        <tbody>
          <tr><th scope="row">C</th><td>caries</td></tr>
          <tr><th scope="row">P</th><td>pulpit</td></tr>
          <tr><th scope="row">R</th><td>root</td></tr>
          <tr><th scope="row">O</th><td>obturation</td></tr>
          <tr><th scope="row">E</th><td>missing</td></tr>
          <tr><th scope="row">K</th><td>artificial tooth</td></tr>
          <tr><th scope="row">X</th><td>implant</td></tr>
          <tr><th scope="row">impl</th><td>crown</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class='row justify-content-end'>
    <input class="col-2" type="submit" value="Save">
  </div>

  <div class="spinner row align-items-center d-none">
    <strong>Loading...</strong>
    <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
  </div>
</form>

<style>
  .cell {
    width: 50px;
    height: 50px;
  }
  .cell .tooth-position,
  .cell input[type=text] {
    height: 100%;
    width: 100%;
    padding: .75rem 0;
    text-align: center;
    border: none;
  }
  .cell .tooth-position {
    cursor: pointer;
  }
  .cell .tooth-position.selected {
    color: white;
    background-color: var(--bs-primary);
  }
  .cell .tooth-position.invalid,
  .cell input.invalid {
    color: white;
    background-color: var(--bs-danger);
  }
  .cell input[type=checkbox] {
    display: none;
  }
</style>

<script>
  ((d, g, TeethMapValidator) => {
    const formId = '#teeth_map_form'
    const toothPositionSelector = '.tooth-position#i%s'
    const validator = new TeethMapValidator(d, toothPositionSelector)

    d.querySelector(`${formId}`).addEventListener('submit', updateToothMap)

    function updateToothMap() {
      event.preventDefault()
      clearAlerts() // from src/templ-notifications.html

      const formData = new FormData(event.target)
      validator.validateTeethMap(formData)
      // TODO: every submissions should have versioning

      if (validator.isTeethMapValid()) {
        toggleFormSpinner()
        const toothMap = mapFormDataToTeethMap(formData)
        // g.script.run.withSuccessHandler(handleSubmissionResponse)
        //   .updateTeethMap(toothMap)
      }
    }

    /**
     * Returns an object with the teeth data
     * @param {FormData} data - The form data
     * @returns {Record<string, string>} - An object with the teeth data
     */
    function mapFormDataToTeethMap(formData) {
      const data = Object.fromEntries(formData)
      const teethIds = getTeethIdFromFormData(data)
      const teethData = {}

      teethIds.forEach(id => teethData[id] = getToothData(id, data))

      return teethData
    }

    /**
     * Returns an array of teeth IDs from the form data
     * @param {FormData} data - The form data
     * @returns {Array<string>} - An array of teeth IDs
     */
    function getTeethIdFromFormData(data) {
      const teethIds = []

      for (const key in data) {
        if (Number(key) && data[key]) {
          teethIds.push(data[key])
        }
      }

      return teethIds
    }

    /**
     * Returns the tooth data from the form data
     * @param {string} id - The tooth ID
     * @param {FormData} data - The form data
     * @returns {string | null} - The tooth data
     */
    function getToothData(id, data) {
      const toothQuadrant = findToothQuadrant(id)
      const toothPosition = id[1]
      const toothData =  data[`q${toothQuadrant}-${toothPosition}`]

      return toothData ? toothData : null
    }

    function findToothQuadrant(id) {
      const firstDigit = Number(id[0])
      return firstDigit <= 4 ? firstDigit : firstDigit - 4
    }

    function toggleFormSpinner() {
      d.querySelector(`${formId} .spinner`).classList.toggle('d-none')
    }
  })(document, google,
    TeethMapValidator // from src/class-teeth-map-validator.html
  );

  /*
   * Tooth map select interaction
   */
  (d => {
    d.querySelectorAll('.tooth-position').forEach(ch => {
      ch.addEventListener('click', (event) => {
        selectTooth(event)
        deselectSamePosition(event)
      })
    })

    function selectTooth(event) {
      const { target } = event
      target.classList.toggle('selected')
      target.classList.remove('invalid')
      const toothId = target.innerText
      const toothSelect = d.querySelector(`input[name="${toothId}"]`)
      toothSelect.checked = target.classList.contains('selected')
    }

    function deselectSamePosition(event) {
      const toothId = event.target.innerText
      const altToothId = findAlternateTooth(toothId)

      if (altToothId != -1) {
        d.querySelector(`.tooth-position#i${altToothId}`)
          ?.classList.remove('selected')
        const altToothSelect = d.querySelector(`input[name="${altToothId}"]`)
        altToothSelect.checked = false
      }
    }

    function findAlternateTooth(id) {
      const firstDigit = Number(id[0])
      const secondDigit = Number(id[1])

      // returns -1 because the following id's don't have alternatives
      if (firstDigit <= 4 && secondDigit > 5) {
        return -1
      }

      return firstDigit <= 4 ? `${firstDigit + 4}${id[1]}` :
        `${firstDigit - 4}${id[1]}`
    }
  })(document)
</script>
