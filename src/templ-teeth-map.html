<form id="teeth_map_form" class="container my-4">
  <header class="row">
    <h2 class="col px-0">Teeth map</h2>
    <div class="spinner spinner-border ms-auto d-none" role="status" aria-hidden="true"></div>
  </header>

  <div class="row">
    <div class="col-8 d-flex flex-column justify-content-center">
      <div class="row">
        <div class="col-6 pe-0 border-end border-dark">
          <div class="d-flex flex-row-reverse">
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-51">51</div><input type="checkbox" name="51" value="51"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-52">52</div><input type="checkbox" name="52" value="52"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-53">53</div><input type="checkbox" name="53" value="53"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-54">54</div><input type="checkbox" name="54" value="54"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-55">55</div><input type="checkbox" name="55" value="55"></div>
          </div>
          <div class="d-flex flex-row-reverse">
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-11">11</div><input type="checkbox" name="11" value="11"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-12">12</div><input type="checkbox" name="12" value="12"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-13">13</div><input type="checkbox" name="13" value="13"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-14">14</div><input type="checkbox" name="14" value="14"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-15">15</div><input type="checkbox" name="15" value="15"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-16">16</div><input type="checkbox" name="16" value="16"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-17">17</div><input type="checkbox" name="17" value="17"></div>
            <div class="cell border-start border-top border-dark"><div class="tooth-select id-18">18</div><input type="checkbox" name="18" value="18"></div>
          </div>
          <div class="d-flex flex-row-reverse border-bottom border-dark">
            <div class="cell border-start border-top border-dark"><input type="text" name="q1-1"></div>
            <div class="cell border-start border-top border-dark"><input type="text" name="q1-2"></div>
            <div class="cell border-start border-top border-dark"><input type="text" name="q1-3"></div>
            <div class="cell border-start border-top border-dark"><input type="text" name="q1-4"></div>
            <div class="cell border-start border-top border-dark"><input type="text" name="q1-5"></div>
            <div class="cell border-start border-top border-dark"><input type="text" name="q1-6"></div>
            <div class="cell border-start border-top border-dark"><input type="text" name="q1-7"></div>
            <div class="cell border-start border-top border-dark"><input type="text" name="q1-8"></div>
          </div>
        </div>

        <div class="col-6 ps-0 border-start border-dark">
          <div class="d-flex flex-row">
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-61">61</div><input type="checkbox" name="61" value="61"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-62">62</div><input type="checkbox" name="62" value="62"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-63">63</div><input type="checkbox" name="63" value="63"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-64">64</div><input type="checkbox" name="64" value="64"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-65">65</div><input type="checkbox" name="65" value="65"></div>
          </div>
          <div class="d-flex flex-row">
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-21">21</div><input type="checkbox" name="21" value="21"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-22">22</div><input type="checkbox" name="22" value="22"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-23">23</div><input type="checkbox" name="23" value="23"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-24">24</div><input type="checkbox" name="24" value="24"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-25">25</div><input type="checkbox" name="25" value="25"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-26">26</div><input type="checkbox" name="26" value="26"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-27">27</div><input type="checkbox" name="27" value="27"></div>
            <div class="cell border-end border-top border-dark"><div class="tooth-select id-28">28</div><input type="checkbox" name="28" value="28"></div>
          </div>
          <div class="d-flex flex-row border-bottom border-dark">
            <div class="cell border-end border-top border-dark"><input type="text" name="q2-1"></div>
            <div class="cell border-end border-top border-dark"><input type="text" name="q2-2"></div>
            <div class="cell border-end border-top border-dark"><input type="text" name="q2-3"></div>
            <div class="cell border-end border-top border-dark"><input type="text" name="q2-4"></div>
            <div class="cell border-end border-top border-dark"><input type="text" name="q2-5"></div>
            <div class="cell border-end border-top border-dark"><input type="text" name="q2-6"></div>
            <div class="cell border-end border-top border-dark"><input type="text" name="q2-7"></div>
            <div class="cell border-end border-top border-dark"><input type="text" name="q2-8"></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-6 pe-0 border-end border-dark">
          <div class="d-flex flex-row-reverse border-top border-dark">
            <div class="cell border-start border-bottom border-dark"><input type="text" name="q4-1"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" name="q4-2"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" name="q4-3"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" name="q4-4"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" name="q4-5"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" name="q4-6"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" name="q4-7"></div>
            <div class="cell border-start border-bottom border-dark"><input type="text" name="q4-8"></div>
          </div>
          <div class="d-flex flex-row-reverse">
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-41">41</div><input type="checkbox" name="41" value="41"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-42">42</div><input type="checkbox" name="42" value="42"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-43">43</div><input type="checkbox" name="43" value="43"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-44">44</div><input type="checkbox" name="44" value="44"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-45">45</div><input type="checkbox" name="45" value="45"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-46">46</div><input type="checkbox" name="46" value="46"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-47">47</div><input type="checkbox" name="47" value="47"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-48">48</div><input type="checkbox" name="48" value="48"></div>
          </div>
          <div class="d-flex flex-row-reverse">
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-81">81</div><input type="checkbox" name="81" value="81"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-82">82</div><input type="checkbox" name="82" value="82"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-83">83</div><input type="checkbox" name="83" value="83"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-84">84</div><input type="checkbox" name="84" value="84"></div>
            <div class="cell border-start border-bottom border-dark"><div class="tooth-select id-85">85</div><input type="checkbox" name="85" value="85"></div>
          </div>
        </div>

        <div class="col-6 ps-0 border-start border-dark">
          <div class="d-flex flex-row border-top border-dark">
            <div class="cell border-end border-bottom border-dark"><input type="text" name="q3-1"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" name="q3-2"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" name="q3-3"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" name="q3-4"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" name="q3-5"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" name="q3-6"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" name="q3-7"></div>
            <div class="cell border-end border-bottom border-dark"><input type="text" name="q3-8"></div>
          </div>
          <div class="d-flex flex-row">
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-31">31</div><input type="checkbox" name="31" value="31"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-32">32</div><input type="checkbox" name="32" value="32"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-33">33</div><input type="checkbox" name="33" value="33"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-34">34</div><input type="checkbox" name="34" value="34"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-35">35</div><input type="checkbox" name="35" value="35"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-36">36</div><input type="checkbox" name="36" value="36"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-37">37</div><input type="checkbox" name="37" value="37"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-38">38</div><input type="checkbox" name="38" value="38"></div>
          </div>
          <div class="d-flex flex-row">
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-71">71</div><input type="checkbox" name="71" value="71"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-72">72</div><input type="checkbox" name="72" value="72"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-73">73</div><input type="checkbox" name="73" value="73"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-74">74</div><input type="checkbox" name="74" value="74"></div>
            <div class="cell border-end border-bottom border-dark"><div class="tooth-select id-75">75</div><input type="checkbox" name="75" value="75"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-4">
      <table class="table">
        <tbody>
          <tr><th scope="row">C</th><td>caries</td></tr>
          <tr><th scope="row">P</th><td>pulpit</td></tr>
          <tr><th scope="row">R</th><td>root</td></tr>
          <tr><th scope="row">O</th><td>obturation</td></tr>
          <tr><th scope="row">E</th><td>missing</td></tr>
          <tr><th scope="row">K</th><td>artificial tooth</td></tr>
          <tr><th scope="row">X</th><td>implant</td></tr>
          <tr><th scope="row">impl</th><td>crown</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class='row justify-content-end'>
    <input class="col-2" type="submit" value="Save">
  </div>

  <div class="spinner row align-items-center d-none">
    <strong>Loading...</strong>
    <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
  </div>
</form>

<style>
  .cell {
    width: 50px;
    height: 50px;
  }
  .cell .tooth-select,
  .cell input[type=text] {
    height: 100%;
    width: 100%;
    padding: .75rem 0;
    text-align: center;
    border: none;
  }
  .cell .tooth-select {
    cursor: pointer;
  }
  .cell .tooth-select.selected {
    color: white;
    background-color: var(--bs-primary);
  }
  .cell .tooth-select.invalid {
    color: white;
    background-color: var(--bs-danger);
  }
  .cell input[type=checkbox] {
    display: none;
  }
</style>

<script>
  ((w, d, g) => {
    const FORM_ID = '#teeth_map_form'
    const TEETH_MAP = {
      1: ['11', '12', '13', '14', '15', '16', '17', '18', '51', '52', '53', '54', '55'],
      2: ['21', '22', '23', '24', '25', '26', '27', '28', '61', '62', '63', '64', '65'],
      3: ['31', '32', '33', '34', '35', '36', '37', '38', '71', '72', '73', '74', '75'],
      4: ['41', '42', '43', '44', '45', '46', '47', '48', '81', '82', '83', '84', '85']
    }

    d.querySelectorAll('.tooth-select').forEach(ch => {
      ch.addEventListener('click', (event) => {
        selectTooth(event)
        deselectSamePosition(event)
      })
    })

    function selectTooth(event) {
      event.target.classList.toggle('selected')
      const toothId = event.target.innerText
      const toothSelect = d.querySelector(`input[name="${toothId}"]`)
      toothSelect.checked = true
    }

    function deselectSamePosition(event) {
      const toothId = event.target.innerText
      const altToothId = findAlternateTooth(toothId)

      if (altToothId != -1) {
        d.querySelector(`.tooth-select.id-${altToothId}`)
          ?.classList.remove('selected')
        const altToothSelect = d.querySelector(`input[name="${altToothId}"]`)
        altToothSelect.checked = false
      }
    }

    function findAlternateTooth(id) {
      const firstDigit = Number(id[0])
      const secondDigit = Number(id[1])

      // returns -1 because the following id's don't have alternatives
      if (firstDigit <= 4 && secondDigit > 5) {
        return -1
      }

      return firstDigit <= 4 ? `${firstDigit + 4}${id[1]}` :
        `${firstDigit - 4}${id[1]}`
    }

    d.querySelector(`${FORM_ID}`).addEventListener('submit', updateToothMap)

    function updateToothMap() {
      event.preventDefault()
      clearAlerts() // from src/templ-notifications.html

      const formData = new FormData(event.target)
      const toothMap = mapFormDataToTeethMap(Object.fromEntries(formData))

      validateTeethPositions(toothMap)
      // TODO: add validation for the missing tooth positions
      // TODO: every submissions should have version

      // toggleFormSpinner()
      // g.script.run.withSuccessHandler(handleSubmissionResponse)
      //   .addPatient(Object.fromEntries(formData))
    }

    /**
     * Returns an object with the teeth data
     * @param {FormData} data - The form data
     * @returns {Record<string, string>} - An object with the teeth data
     */
    function mapFormDataToTeethMap(data) {
      const teethIds = getTeethIdFromFormData(data)
      const teethData = {}

      teethIds.forEach(id => teethData[id] = getToothData(id, data))

      return teethData
    }

    /**
     * Returns an array of teeth IDs from the form data
     * @param {FormData} data - The form data
     * @returns {Array<string>} - An array of teeth IDs
     */
    function getTeethIdFromFormData(data) {
      const teethIds = []

      for (const key in data) {
        if (data[key] && Number(key)) {
          teethIds.push(data[key])
        }
      }

      return teethIds
    }

    /**
     * Returns the tooth data from the form data
     * @param {string} id - The tooth ID
     * @param {FormData} data - The form data
     * @returns {string | null} - The tooth data
     */
    function getToothData(id, data) {
      const toothQuadrant = findToothQuadrant(id)
      const toothPosition = id[1]
      const toothData =  data[`q${toothQuadrant}-${toothPosition}`]

      return toothData ? toothData : null
    }

    function findToothQuadrant(id) {
      const firstDigit = Number(id[0])
      return firstDigit <= 4 ? firstDigit : firstDigit - 4
    }

    function validateTeethPositions(data) {
      for (const key in data) {
        if (data[key] === null) {
          d.querySelector(`.tooth-select.id-${key}`).classList.add('invalid')
        }
      }
    }

    function toggleFormSpinner() {
      d.querySelector(`${FORM_ID} .spinner`).classList.toggle('d-none')
    }

  })(window, document, google)
</script>
